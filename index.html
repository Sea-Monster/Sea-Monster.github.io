<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="量">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="量">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="量">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>量</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">量</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/Elasticsearch聚合查询/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/Elasticsearch聚合查询/" itemprop="url">Elasticsearch聚合查询</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-05T19:49:07+08:00">
                2020-03-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Elasticsearch的一些稍微复杂一些的聚合查询，平时更多使用MySQL，更熟悉MySQL一些。因此我们以MySQL作为例子，由较熟悉的SQL语句转化为ES查询语句</p>
</blockquote>
<h1 id="MySQL表结构"><a href="#MySQL表结构" class="headerlink" title="MySQL表结构"></a>MySQL表结构</h1><p>两个表：项目表t_project，客户表t_customer，多对一的关系   </p>
<h2 id="项目表t-project"><a href="#项目表t-project" class="headerlink" title="项目表t_project"></a>项目表t_project</h2><p>结构与示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>prj_id</th>
<th>prj_name</th>
<th>bid_price</th>
<th>customer_id</th>
<th>deal_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>PRJ001</td>
<td>项目1</td>
<td>1000000</td>
<td>1</td>
<td>2020-01-05</td>
</tr>
<tr>
<td>2</td>
<td>PRJ002</td>
<td>项目2</td>
<td>2000000</td>
<td>1</td>
<td>2020-02-05</td>
</tr>
<tr>
<td>3</td>
<td>PRJ003</td>
<td>项目3</td>
<td>3500000</td>
<td>2</td>
<td>2020-02-19</td>
</tr>
</tbody>
</table>
<h2 id="客户表t-customer"><a href="#客户表t-customer" class="headerlink" title="客户表t_customer"></a>客户表t_customer</h2><p>结构与示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>comp_name</th>
<th>province</th>
<th>city</th>
<th>area</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>企业A</td>
<td>广东省</td>
<td>广州市</td>
<td>越秀区</td>
</tr>
<tr>
<td>2</td>
<td>企业B</td>
<td>广东省</td>
<td>深圳市</td>
<td>罗湖区</td>
</tr>
<tr>
<td>3</td>
<td>企业C</td>
<td>四川省</td>
<td>成都市</td>
<td>武侯区</td>
</tr>
</tbody>
</table>
<h1 id="Elasticsearch索引结构"><a href="#Elasticsearch索引结构" class="headerlink" title="Elasticsearch索引结构"></a>Elasticsearch索引结构</h1><p>这里我们采用了nested的方式组织project和customer。每个project都嵌一个customer对象。所以，这里就只使用一个索引：project。（注意，可以看到这里customer对象只有comp_name，没有id，请不要深究，反正假定customer的id与comp_name都是一一对应）<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;	</span><br><span class="line">	&quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;prj_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;prj_name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;deal_time&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;customer&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;comp_name&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">		&quot;province&quot;:&#123;</span><br><span class="line">                  &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;city&quot;:&#123;</span><br><span class="line">                  &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;area&quot;:&#123;</span><br><span class="line">                  &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;bid_price&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;scaled_float&quot;,</span><br><span class="line">            &quot;scaling_factor&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a>查询示例</h1><h2 id="例子1-统计项目数"><a href="#例子1-统计项目数" class="headerlink" title="例子1 统计项目数"></a>例子1 统计项目数</h2><p>统计每个客户对应项目数，返回项目前100多的客户。</p>
<h3 id="MySQL查询语句"><a href="#MySQL查询语句" class="headerlink" title="MySQL查询语句"></a>MySQL查询语句</h3><p>这个比较简答，可以是：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(1) as cnt, comp_name from t_project inner join t_customer on t_project.customer_id=t_customer.id group by t_customer.comp_name order by cnt desc limit 100</span><br></pre></td></tr></table></figure></p>
<h3 id="Elasticsearch查询语句"><a href="#Elasticsearch查询语句" class="headerlink" title="Elasticsearch查询语句"></a>Elasticsearch查询语句</h3><p>统计每个customer对应的文档数目，返回前100名的customer的name和它对应的文档数目，默认就是从大到小排列，语句如下：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /project/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;customer&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;customer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;customer1&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;customer.name&quot;,</span><br><span class="line">            &quot;size&quot;: 100</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="额外的限制条件"><a href="#额外的限制条件" class="headerlink" title="额外的限制条件"></a>额外的限制条件</h4><p>假设我们想把企业A排除在外，统计每个customer对应的文档数目，返回前100名的customer的name和它对应的文档数目，语句如下：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET /project/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;nested&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;customer&quot;,</span><br><span class="line">            &quot;query&quot;: &#123;</span><br><span class="line">              &quot;match&quot;: &#123;</span><br><span class="line">                &quot;customer.name&quot;: &quot;企业A&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;customer&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;customer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;customer1&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;customer.name&quot;,</span><br><span class="line">            &quot;size&quot;: 100</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="例子2-统计项目金额，并按子聚合结果进行排序"><a href="#例子2-统计项目金额，并按子聚合结果进行排序" class="headerlink" title="例子2 统计项目金额，并按子聚合结果进行排序"></a>例子2 统计项目金额，并按子聚合结果进行排序</h2><p>统计每个客户对应项目的金额总数（bid_price），返回总金额前100多的客户。</p>
<h3 id="MySQL查询语句-1"><a href="#MySQL查询语句-1" class="headerlink" title="MySQL查询语句"></a>MySQL查询语句</h3><p>如下：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sum(bid_price) as bid_price_sum, comp_name from t_project inner join t_customer on t_project.customer_id=t_customer.id group by t_customer.comp_name order by bid_price_sum desc limit 100</span><br></pre></td></tr></table></figure></p>
<h3 id="Elasticsearch查询语句-1"><a href="#Elasticsearch查询语句-1" class="headerlink" title="Elasticsearch查询语句"></a>Elasticsearch查询语句</h3><p>这里就比较复杂了，因为分桶是nested对象里的属性，但统计的却是其外层的某个属性，我网上学习了很长时间，搜了很多文章，感觉没什么文章把什么分桶说得明明白白的，我也没办法说明白，只好举例：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;:0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;cust&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;customer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;cust1&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;customer.name&quot;,</span><br><span class="line">            &quot;size&quot;: 100,</span><br><span class="line">            &quot;order&quot;:&#123;</span><br><span class="line">            	&quot;money&gt;money1&quot;:&quot;desc&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;money&quot;: &#123;</span><br><span class="line">              &quot;reverse_nested&quot;: &#123;&#125;, </span><br><span class="line">              &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;money1&quot;: &#123;</span><br><span class="line">                  &quot;sum&quot;: &#123;</span><br><span class="line">                    &quot;field&quot;: &quot;bid_price&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; </span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重点留意这里，理解<code>money&gt;money1</code>的意思，对应哪里的名字：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;order&quot;:&#123;</span><br><span class="line">	&quot;money&gt;money1&quot;:&quot;desc&quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>此外还有这句，把“路径跳回上一级”：<code>&quot;reverse_nested&quot;: {}</code></p>
<h2 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h2><p>统计每个省份的项目数、项目金额总数，查询项目金额总数的前10个省份及对应的金额。</p>
<h3 id="MySQL查询语句-2"><a href="#MySQL查询语句-2" class="headerlink" title="MySQL查询语句"></a>MySQL查询语句</h3><p>这里我使用子查询<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUM(A.bid_price) as bid_price_sum, A.province from</span><br><span class="line">(</span><br><span class="line">SELECT t_project.bid_price, t_customer.province </span><br><span class="line">from t_project inner join t_customer on  t_project.customer_id=t_customer.id</span><br><span class="line">) A GROUP BY A.province</span><br><span class="line">ORDER BY bid_price_sum DESC limit 10</span><br></pre></td></tr></table></figure></p>
<h3 id="Elasticsearch查询语句-2"><a href="#Elasticsearch查询语句-2" class="headerlink" title="Elasticsearch查询语句"></a>Elasticsearch查询语句</h3><p>与第2个例子道理基本一样：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;:0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;cust&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;customer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;cust1&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;customer.province&quot;,</span><br><span class="line">            &quot;size&quot;: 10,</span><br><span class="line">            &quot;order&quot;:&#123;</span><br><span class="line">            	&quot;money&gt;money1&quot;:&quot;desc&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;money&quot;: &#123;</span><br><span class="line">              &quot;reverse_nested&quot;: &#123;&#125;, </span><br><span class="line">              &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;money1&quot;: &#123;</span><br><span class="line">                  &quot;sum&quot;: &#123;</span><br><span class="line">                    &quot;field&quot;: &quot;bid_price&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; </span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="例子4-分桶聚合后再做过滤"><a href="#例子4-分桶聚合后再做过滤" class="headerlink" title="例子4 分桶聚合后再做过滤"></a>例子4 分桶聚合后再做过滤</h2><p>统计每个省份的项目数、项目金额总数，查询项目金额总数的前10个省份及对应的金额，只显示总金额大于1千万的省份（相当于MySQL的having语句）</p>
<h3 id="MySQL查询语句-3"><a href="#MySQL查询语句-3" class="headerlink" title="MySQL查询语句"></a>MySQL查询语句</h3><p>这里我使用子查询<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUM(A.bid_price) as bid_price_sum, A.province from</span><br><span class="line">(</span><br><span class="line">SELECT t_project.bid_price, t_customer.province </span><br><span class="line">from t_project inner join t_customer on  t_project.customer_id=t_customer.id</span><br><span class="line">) A GROUP BY A.province HAVING bid_price_sum&gt;=10000000</span><br><span class="line">ORDER BY bid_price_sum DESC limit 10</span><br></pre></td></tr></table></figure></p>
<h3 id="Elasticsearch查询语句-3"><a href="#Elasticsearch查询语句-3" class="headerlink" title="Elasticsearch查询语句"></a>Elasticsearch查询语句</h3><p>这里用到<code>bucket_selector</code>的语法：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
<th>是否必填</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>script</td>
<td>过滤条件</td>
<td>是</td>
<td>无</td>
</tr>
<tr>
<td>buckets_path</td>
<td>上层聚合的变量</td>
<td>是</td>
<td>无</td>
</tr>
<tr>
<td>gap_policy</td>
<td>当出现间隔时候的处理方式</td>
<td>否</td>
<td>skip</td>
</tr>
</tbody>
</table>
<p>此外要注意的是<strong>“elasticsearch中bucket_script聚合父级必须是多桶聚合”</strong>：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;cust&quot;: &#123;</span><br><span class="line">            &quot;nested&quot;: &#123;</span><br><span class="line">                &quot;path&quot;: &quot;customer&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;cust1&quot;: &#123;</span><br><span class="line">                    &quot;terms&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: &quot;customer.province&quot;,</span><br><span class="line">                        &quot;size&quot;: 10,</span><br><span class="line">                        &quot;order&quot;: &#123;</span><br><span class="line">                            &quot;money&gt;money1&quot;: &quot;desc&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;aggs&quot;: &#123;</span><br><span class="line">                        &quot;money&quot;: &#123;</span><br><span class="line">                            &quot;reverse_nested&quot;: &#123;&#125;,</span><br><span class="line">                            &quot;aggs&quot;: &#123;</span><br><span class="line">                                &quot;money1&quot;: &#123;</span><br><span class="line">                                    &quot;sum&quot;: &#123;</span><br><span class="line">                                        &quot;field&quot;: &quot;bid_price&quot;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;having1&quot;: &#123;</span><br><span class="line">                            &quot;bucket_selector&quot;: &#123;</span><br><span class="line">                                &quot;buckets_path&quot;: &#123;</span><br><span class="line">                                    &quot;having_money&quot;: &quot;money&gt;money1&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;script&quot;: &#123;</span><br><span class="line">                                    &quot;source&quot;: &quot;params.having_money&gt;10000000&quot;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到“having1”我放在了跟“money”同一级而不是跟“money1”同一级，否则，会报错：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;error&quot;: &#123;</span><br><span class="line">        &quot;root_cause&quot;: [],</span><br><span class="line">        &quot;type&quot;: &quot;search_phase_execution_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;&quot;,</span><br><span class="line">        &quot;phase&quot;: &quot;fetch&quot;,</span><br><span class="line">        &quot;grouped&quot;: true,</span><br><span class="line">        &quot;failed_shards&quot;: [],</span><br><span class="line">        &quot;caused_by&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;class_cast_exception&quot;,</span><br><span class="line">            &quot;reason&quot;: &quot;class org.elasticsearch.search.aggregations.bucket.nested.InternalReverseNested cannot be cast to class org.elasticsearch.search.aggregations.InternalMultiBucketAggregation (org.elasticsearch.search.aggregations.bucket.nested.InternalReverseNested and org.elasticsearch.search.aggregations.InternalMultiBucketAggregation are in unnamed module of loader &apos;app&apos;)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;status&quot;: 503</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Elasticsearch聚合查询的精准度问题"><a href="#Elasticsearch聚合查询的精准度问题" class="headerlink" title="Elasticsearch聚合查询的精准度问题"></a>Elasticsearch聚合查询的精准度问题</h1><p>Elasticsearch分布式系统采用近似统计算法，数据量、精准度、实时性3者只能同时满足其中2条。既然是近似算法，那么返回的Top N结果就不一定准确，因为数据分散在各个分片上，Coordinating Node无法获取数据全貌。解决方案有2种：</p>
<h2 id="解决方案1：设置Primary-Shard为1"><a href="#解决方案1：设置Primary-Shard为1" class="headerlink" title="解决方案1：设置Primary Shard为1"></a>解决方案1：设置Primary Shard为1</h2><p>数据量不大时可以采用这种方法，创建索引时，把<code>number_of_shards</code>设置为1，那么数据就不会在各个节点上仅仅保存其中一部分，而是全数存储，那么统计时就可以在其节点上获取数据全貌，统计结果自然也就准确了。</p>
<h2 id="解决方案2：设置shard-size参数"><a href="#解决方案2：设置shard-size参数" class="headerlink" title="解决方案2：设置shard_size参数"></a>解决方案2：设置shard_size参数</h2><p>数据量很大时，我们可以在查询时设置<code>shard_size</code>参数，以增加整体计算量降低响应时间的代价来提高精准度。</p>
<ul>
<li>shard size的默认大小为<code>size*1.5+10</code>   </li>
</ul>
<p>示例：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;customer&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;customer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;customer1&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;customer.name&quot;,</span><br><span class="line">            &quot;size&quot;: 100,</span><br><span class="line">            &quot;shard_size&quot;: 1000,</span><br><span class="line">            &quot;show_term_doc_count_error&quot;: true,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://www.voidcn.com/article/p-dcdsbdhz-bod.html" title="ElasticSearch:桶过滤聚合(Bucket Selector Aggregation)" target="_blank" rel="noopener">http://www.voidcn.com/article/p-dcdsbdhz-bod.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/查看一个运行Docker容器的docker-run启动参数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/查看一个运行Docker容器的docker-run启动参数/" itemprop="url">查看一个运行Docker容器的docker run启动参数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-05T10:34:22+08:00">
                2020-03-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>假设我没有使用Docker-compose，我的某个Docker容器是直接用docker run命令运行的，我想查看当时这个容器运行的参数，要如何查看呢？<br>有个名为<code>runlike</code>的Docker镜像可以解决这个问题。<br>首先我们下载这个镜像：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull assaflavie/runlike</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>然后运行命令，最后的参数就是我们想获取“启动参数”的容器名：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -v /var/run/docker.sock:/var/run/docker.sock  assaflavie/runlike python-container</span><br><span class="line"></span><br><span class="line">docker run --name=python-container --hostname=883a78c19cfd --env=&quot;PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot; --env=&quot;LANG=C.UTF-8&quot; --env=&quot;GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D&quot; --env=&quot;PYTHON_VERSION=3.6.8&quot; --env=&quot;PYTHON_PIP_VERSION=19.1.1&quot; --volume=&quot;/home/tisson/python:/home&quot; --volume=&quot;/home/tisson/files_crawler:/files_crawler&quot; --volume=&quot;/etc/localtime:/etc/localtime:ro&quot; --volume=&quot;/etc/timezone:/etc/timezone:ro&quot; -p 38888:8888 --restart=no --detach=true mypy3.6:20191111 /bin/bash -c &apos;while true;do echo hello docker;sleep 1;done&apos;</span><br></pre></td></tr></table></figure></p>
<p>当然，有部分我们当初运行容器时并没有输入，是它自己默认的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/04/Mac使用VPN一点心得/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/04/Mac使用VPN一点心得/" itemprop="url">Mac使用VPN一点心得</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-04T20:24:56+08:00">
                2020-02-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近疫情严重，公司要求在家办公。远程办公自然少不了VPN。但是公司的VPN有些弱，连着就访问不了外网，难道我需要不停的对VPN打开关闭？<br>方法是对网络添加路由，仅仅让某些ip地址（例如172开头，10开头）走VPN，其余走平常的网络。步骤如下：   </p>
</blockquote>
<h2 id="1-VPN中“通过VPN连接发送所有流量”不能勾选。"><a href="#1-VPN中“通过VPN连接发送所有流量”不能勾选。" class="headerlink" title="1. VPN中“通过VPN连接发送所有流量”不能勾选。"></a>1. VPN中“通过VPN连接发送所有流量”不能勾选。</h2><h2 id="2-查看VPN的“名称”"><a href="#2-查看VPN的“名称”" class="headerlink" title="2. 查看VPN的“名称”"></a>2. 查看VPN的“名称”</h2><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig</span><br><span class="line">lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 16384</span><br><span class="line">    options=3&lt;RXCSUM,TXCSUM&gt;</span><br><span class="line">    inet6 ::1 prefixlen 128</span><br><span class="line">    inet 127.0.0.1 netmask 0xff000000</span><br><span class="line">    inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1</span><br><span class="line">    nd6 options=1&lt;PERFORMNUD&gt;</span><br><span class="line">gif0: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280</span><br><span class="line">stf0: flags=0&lt;&gt; mtu 1280</span><br><span class="line">en0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">    ether c4:b3:01:d4:0f:13</span><br><span class="line">    inet6 fe80::c6b3:1ff:fed4:f13%en0 prefixlen 64 scopeid 0x4</span><br><span class="line">    inet 192.168.0.103 netmask 0xffffff00 broadcast 192.168.0.255</span><br><span class="line">    nd6 options=1&lt;PERFORMNUD&gt;</span><br><span class="line">    media: autoselect</span><br><span class="line">    status: active</span><br><span class="line">en1: flags=963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX&gt; mtu 1500</span><br><span class="line">    options=60&lt;TSO4,TSO6&gt;</span><br><span class="line">    ether 4a:00:07:96:39:f0</span><br><span class="line">    media: autoselect &lt;full-duplex&gt;</span><br><span class="line">    status: inactive</span><br><span class="line">en2: flags=963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX&gt; mtu 1500</span><br><span class="line">    options=60&lt;TSO4,TSO6&gt;</span><br><span class="line">    ether 4a:00:07:96:39:f1</span><br><span class="line">    media: autoselect &lt;full-duplex&gt;</span><br><span class="line">    status: inactive</span><br><span class="line">p2p0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 2304</span><br><span class="line">    ether 06:b3:01:d4:0f:13</span><br><span class="line">    media: autoselect</span><br><span class="line">    status: inactive</span><br><span class="line">bridge0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">    options=63&lt;RXCSUM,TXCSUM,TSO4,TSO6&gt;</span><br><span class="line">    ether c6:b3:01:4d:e3:00</span><br><span class="line">    Configuration:</span><br><span class="line">        id 0:0:0:0:0:0 priority 0 hellotime 0 fwddelay 0</span><br><span class="line">        maxage 0 holdcnt 0 proto stp maxaddr 100 timeout 1200</span><br><span class="line">        root id 0:0:0:0:0:0 priority 0 ifcost 0 port 0</span><br><span class="line">        ipfilter disabled flags 0x2</span><br><span class="line">    member: en1 flags=3&lt;LEARNING,DISCOVER&gt;</span><br><span class="line">            ifmaxaddr 0 port 5 priority 0 path cost 0</span><br><span class="line">    member: en2 flags=3&lt;LEARNING,DISCOVER&gt;</span><br><span class="line">            ifmaxaddr 0 port 6 priority 0 path cost 0</span><br><span class="line">    nd6 options=1&lt;PERFORMNUD&gt;</span><br><span class="line">    media: &lt;unknown type&gt;</span><br><span class="line">    status: inactive</span><br><span class="line">awdl0: flags=8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1484</span><br><span class="line">    ether 6e:41:77:57:bd:58</span><br><span class="line">    inet6 fe80::6c41:77ff:fe57:bd58%awdl0 prefixlen 64 scopeid 0x9</span><br><span class="line">    nd6 options=1&lt;PERFORMNUD&gt;</span><br><span class="line">    media: autoselect</span><br><span class="line">    status: active</span><br><span class="line">ppp0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1280</span><br><span class="line">    inet 192.168.200.2 --&gt; 192.168.200.1 netmask 0xffffff00</span><br></pre></td></tr></table></figure>
</code></pre><p>在这里，ppp0就是VPN对应的网络名称。</p>
<h2 id="3-添加路由："><a href="#3-添加路由：" class="headerlink" title="3.  添加路由："></a>3.  添加路由：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo route -n add -net 172.16 -netmask 255.255.0.0 `ifconfig ppp0 | awk &apos;NR==2 &#123;print $2&#125;&apos;`</span><br><span class="line">add net 172.16: gateway 192.168.200.2</span><br><span class="line">$ sudo route -n add -net 10.202 -netmask 255.255.0.0 `ifconfig ppp0 | awk &apos;NR==2 &#123;print $2&#125;&apos;`</span><br><span class="line">add net 10.202: gateway 192.168.200.2</span><br></pre></td></tr></table></figure>
<p>这样，只有访问172.16和10.202开头的ip地址时会走VPN。注意，当VPN重新打开时，我们需要重复步骤3：添加理由。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/pymysql获取新插入数据的id/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/08/pymysql获取新插入数据的id/" itemprop="url">pymysql获取新插入数据的id</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-08T14:49:59+08:00">
                2019-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>MySQL数据表字段为自增长，当我们往该表添加记录时，自增长列会自行填充数据，但是如何获取它自行填充的值呢？</p>
</blockquote>
<p>例如我有一个数据表<code>t_generate_id</code>，里边就一个字段：自增长列<code>id</code>。我们使用的是<code>pymysql</code>，每次往表新增数据时获取刚才新增记录的id值，最简单的方法如下：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import pymsql</span><br><span class="line">conn = pymysql.connect(host=&apos;172.16.27.40&apos;, user=&apos;test&apos;, password=&quot;123456&quot;, database=&apos;test1&apos;, port=3306, charset=&apos;utf8mb4&apos;)</span><br><span class="line">try:</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(&apos;insert into t_generate_id () values ()&apos;)</span><br><span class="line">    last_id = cursor.lastrowid</span><br><span class="line">    conn.commit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    conn.rollback()</span><br><span class="line">finally:</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure></p>
<p>注意：    </p>
<ol>
<li>插入记录时，不能自己去指定自增列的值，这样才能使用<code>cursor.lastrowid</code>获取插入数据的自增长列的值，否则结果都是0。</li>
<li>记得commit。否则<code>auto_increment</code>的值是获取到了，但是记录并没有写入数据库。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/CentOS7下修改Docker工作目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/08/CentOS7下修改Docker工作目录/" itemprop="url">CentOS7下修改Docker工作目录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-08T14:48:21+08:00">
                2019-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>服务器系统盘空间不是很充足，而Docker的环境体积又比较大，有必要把其工作目录放到空间较大的数据盘。</p>
</blockquote>
<p>Docker安装时如果不指定工作目录，一般默认工作目录是<code>/var/lib/docker</code>。<br>我们可以先查看一下docker运行的工作目录：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker info |grep &quot;Docker Root Dir&quot;</span><br><span class="line">Docker Root Dir: /var/lib/docker</span><br></pre></td></tr></table></figure></p>
<p>现在我们需要把工作目录改为<code>/data/docker</code>，网上提到有2种方法：</p>
<h1 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h1><p>新建或者编辑<code>/etc/docker/daemon.json</code>：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;data-root&quot;: &quot;/data/docker&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后重启Docker：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart docker</span><br></pre></td></tr></table></figure></p>
<h1 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h1><p>编辑文件<code>/usr/lib/systemd/system/docker.service</code><br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --data-root=/data/docker</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2……</span><br></pre></td></tr></table></figure></p>
<p>重启docker:<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart docker</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/15/解决MongoDB游标超时的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/15/解决MongoDB游标超时的问题/" itemprop="url">解决MongoDB游标超时的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-15T11:31:16+08:00">
                2019-10-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>当我们用Python从MongoDB中查数据时，经常遇到游标。实际上不止是MongoDB，我们用MySQL之类，同样也经常用到游标，用游标会出现什么问题，又是如何解决呢？</p>
</blockquote>
<h1 id="使用游标可能遇到的问题"><a href="#使用游标可能遇到的问题" class="headerlink" title="使用游标可能遇到的问题"></a>使用游标可能遇到的问题</h1><p>我们可能这样写代码<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import pymongo</span><br><span class="line">from urllib.parse import quote_plus</span><br><span class="line"></span><br><span class="line">uri = &quot;mongodb://%s:%s@%s&quot; % (quote_plus(&apos;mongo-admin&apos;), quote_plus(&apos;tisson!1&apos;), &quot;aliyun:37071&quot;)</span><br><span class="line"></span><br><span class="line">client = MongoClient(uri)</span><br><span class="line"># crawler为“库名”，collection_1为Collection名，也可以理解为“表名”</span><br><span class="line">my_set = client.crawler.collection_1</span><br><span class="line">for item in my_set.find():</span><br><span class="line">    # 处理找到的数据</span><br><span class="line">    process_data(item)</span><br></pre></td></tr></table></figure></p>
<p>短短几行代码，读取MongoDB中某个表的每一行数据，然后由<code>process _data</code>方法做处理，处理完后再读取下一行，逻辑清晰而简单，能有什么问题？<code>process _data(item)</code>不报错，这一段代码就完美无缺。<br>然而事实并非这样，代码可能会在<code>for item in my_set.find():</code>这一行中报错，而且不是一开始就报错，有可能跑了循环中的若干次后才报错，怎么回事呢？<br>原来<code>my_set.find()</code>返回的并不是数据库里的数据，而是一个游标（Cursor）对象，只有当你使用for循环开始迭代它的时候，游标才会真正去数据库。但是，如果每一次循环都连接数据库，那么网络连接会浪费大量的时间。所以pymongo会一次性获取100行，<code>my_set.find()</code>循环第一次时，它会连上MongoDB，读取一百条数据，缓存到内存中。于是循环的第2-100次，数据都是直接从内存中获取，不会连接数据库。当循环进行到第101次时，再一次连接数据库，获取第101-200行的内容。<br>这个逻辑非常有效的降低了网络I/O耗时，但是，MongoDB默认游标的超时时间是10分钟。10分钟之内，必需再次连接MongoDB读取内容刷新游标时间，否则，就会导致游标超时报错：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pymongo.errors.CursorNotFound: cursor id 40929404302 not found</span><br></pre></td></tr></table></figure></p>
<p>也就是说，如果<code>process _data(item)</code>执行100次的时间超过10分钟，即使该方法没报错，那么等它跑完，需要重新连接数据库获取下100条记录的时候，由于游标超时，就会报错。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>为了解决以上问题，我们有4种办法</p>
<h2 id="修改MongoDB配置"><a href="#修改MongoDB配置" class="headerlink" title="修改MongoDB配置"></a>修改MongoDB配置</h2><p>修改MongoDB的配置，延长游标超时时间，并重启MongoDB。假如是生产环境的数据库，按理说不能随便重启，因此这个做法要慎重。</p>
<h2 id="一次性读取所有数据"><a href="#一次性读取所有数据" class="headerlink" title="一次性读取所有数据"></a>一次性读取所有数据</h2><p>一次性把数据全部读取下来，再做处理：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rs_list = [r for r in my_set.find()]</span><br><span class="line">for r in rs_list:</span><br><span class="line">    process_data(r)</span><br></pre></td></tr></table></figure></p>
<p>这种方案的弊端也很明显，如果数据量非常大，你不一定能全部放到内存里面。即使能够全部放到内存中，但是列表推导式遍历了所有数据，紧接着for循环又遍历一次，浪费了时间。不过，暂时在实际情况中，我较常使用这种处理办法，因为处理简单。</p>
<h2 id="减少游标每次返回数据量"><a href="#减少游标每次返回数据量" class="headerlink" title="减少游标每次返回数据量"></a>减少游标每次返回数据量</h2><p>如果处理100条数据会超过10分钟的超时时间，那么我们减少游标每次返回的数据量，例如50条：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for item in my_set.find().batch_size(50):</span><br><span class="line">    process_data(item)</span><br></pre></td></tr></table></figure></p>
<p>但这种方案会增加数据库的连接次数，从而增加I/O耗时。</p>
<h2 id="让Pymongo的游标永不超时"><a href="#让Pymongo的游标永不超时" class="headerlink" title="让Pymongo的游标永不超时"></a>让Pymongo的游标永不超时</h2><p>通过设定参数<code>no_cursor_timeout=True</code>，让游标永不超时，游标最后必须手动关闭：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cursor = my_set.find(no_cursor_timeout=True)</span><br><span class="line">for row in cursor:</span><br><span class="line">    process_data(row)</span><br><span class="line"># 一定要手动关闭游标</span><br><span class="line">cursor.close()</span><br></pre></td></tr></table></figure></p>
<p>然而这个操作非常危险，因为如果你的Python程序因为某种原因意外停止了，这个游标就再也无法关闭了！除非重启MongoDB，否则这些游标会一直留在MongoDB上，占用资源。<br>因此，我们需要把这个做法稍作改良</p>
<h3 id="使用try、catch、finally"><a href="#使用try、catch、finally" class="headerlink" title="使用try、catch、finally"></a>使用try、catch、finally</h3><p>最容易想到的做法，即使抛出异常，finally部分的代码依然会执行<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cursor = my_set.find(no_cursor_timeout=True)</span><br><span class="line">try:</span><br><span class="line">    for row in cursor:</span><br><span class="line">        process_data(row)</span><br><span class="line">except Exception:</span><br><span class="line">    # 处理异常</span><br><span class="line">    handle_exception()</span><br><span class="line">finally:</span><br><span class="line">    # 一定要手动关闭游标</span><br><span class="line">    cursor.close()</span><br></pre></td></tr></table></figure></p>
<h3 id="使用上下文管理器"><a href="#使用上下文管理器" class="headerlink" title="使用上下文管理器"></a>使用上下文管理器</h3><p>try/catch比较难看，Python还提供了上下文管理器，例如文件的读取与写入我们就可以用上下文管理器：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">with my_set.find(no_cursor_timeout=True) as cursor:</span><br><span class="line">    for row in cursor:</span><br><span class="line">        process_data(row)</span><br></pre></td></tr></table></figure></p>
<p>只要程序退出了with的缩进，游标自动就会关闭。如果程序中途报错，游标也会关闭。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/07/为基于Debian的Docker镜像更换镜像源/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/07/为基于Debian的Docker镜像更换镜像源/" itemprop="url">为基于Debian的Docker镜像更换镜像源</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-07T20:32:51+08:00">
                2019-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>docker 官方的镜像大多基于debian，但是官方源apt-get update经常更新失败，要不就是速度很慢，我们需要添加/更换成中国的源</p>
</blockquote>
<h1 id="创建镜像时添加-更换"><a href="#创建镜像时添加-更换" class="headerlink" title="创建镜像时添加/更换"></a>创建镜像时添加/更换</h1><p>可以选择阿里云的源或者网易的源</p>
<h2 id="阿里云的源"><a href="#阿里云的源" class="headerlink" title="阿里云的源"></a>阿里云的源</h2><p>在Dockerfile中添加如下指令：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RUN mv /etc/apt/sources.list /etc/apt/sources.list.bak &amp;&amp; \</span><br><span class="line">	echo &quot;deb http://mirrors.aliyun.com/debian wheezy main contrib non-free&quot; &gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb-src http://mirrors.aliyun.com/debian wheezy main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb http://mirrors.aliyun.com/debian wheezy-updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb-src http://mirrors.aliyun.com/debian wheezy-updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb http://mirrors.aliyun.com/debian-security wheezy/updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb-src http://mirrors.aliyun.com/debian-security wheezy/updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br></pre></td></tr></table></figure></p>
<h2 id="网易的源"><a href="#网易的源" class="headerlink" title="网易的源"></a>网易的源</h2><p>在Dockerfile中添加如下指令：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RUN mv /etc/apt/sources.list /etc/apt/sources.list.bak &amp;&amp; \</span><br><span class="line">	echo &quot;deb http://mirrors.163.com/debian/ jessie main non-free contrib&quot; &gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb http://mirrors.163.com/debian/ jessie-proposed-updates main non-free contrib&quot; &gt;&gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb-src http://mirrors.163.com/debian/ jessie main non-free contrib&quot; &gt;&gt;/etc/apt/sources.list &amp;&amp; \</span><br><span class="line">	echo &quot;deb-src http://mirrors.163.com/debian/ jessie-proposed-updates main non-free contrib&quot; &gt;&gt;/etc/apt/sources.list</span><br></pre></td></tr></table></figure></p>
<h1 id="容器运行后添加-更换"><a href="#容器运行后添加-更换" class="headerlink" title="容器运行后添加/更换"></a>容器运行后添加/更换</h1><p>首先进入容器：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it 容器名 bash</span><br></pre></td></tr></table></figure></p>
<p>然后备份一下/etc/apt/sources.list：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mv /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure></p>
<p>然后往/etc/apt/sources.list添加源（和上边“创建镜像时添加”一样，这里我们以使用阿里云为例）<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;deb http://mirrors.aliyun.com/debian wheezy main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br><span class="line">$ echo &quot;deb-src http://mirrors.aliyun.com/debian wheezy main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br><span class="line">$ echo &quot;deb http://mirrors.aliyun.com/debian wheezy-updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br><span class="line">$ echo &quot;deb-src http://mirrors.aliyun.com/debian wheezy-updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br><span class="line">$ echo &quot;deb http://mirrors.aliyun.com/debian-security wheezy/updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br><span class="line">$ echo &quot;deb-src http://mirrors.aliyun.com/debian-security wheezy/updates main contrib non-free&quot; &gt;&gt;/etc/apt/sources.list</span><br></pre></td></tr></table></figure></p>
<p>接下来执行以下命令，就完成阿里云镜像源了<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update</span><br></pre></td></tr></table></figure></p>
<p>由于是在容器内变更的，因此容器删除后就没了，我们可以考虑把这个更换了镜像源的容器变为一个新的Docker镜像，这样就不用每次创建容器后再去更改Debian镜像源。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/02/Docker容器转镜像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/02/Docker容器转镜像/" itemprop="url">Docker容器转镜像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-02T00:46:47+08:00">
                2019-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>有些时候我们在Docker容器内装了某些东西，那要维持那套环境只能一直使用该容器了，如果遇到需要更改环境配置（例如端口映射变更，数据盘映射变更等），需要删掉容器，用镜像文件重新创建容器，又希望能继续使用之前在容器内安装的东西，怎么办呢？</p>
</blockquote>
<p>答案就是把容器内容保存下来，转换成镜像。以后就用这个镜像创建容器。<br>我们将使用docker commit命令：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br></pre></td></tr></table></figure></p>
<p>OPTIONS说明：<br>-a :提交的镜像作者<br>-c :使用Dockerfile指令来创建镜像；<br>-m :提交时的说明文字；<br>-p :在commit时，将容器暂停。 </p>
<p>例如，我们把ID是bc52b8d6886c的容器转化成名为new-image，tag为2.0的镜像：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker commit bc52b8d6886c new-image:2.0</span><br></pre></td></tr></table></figure></p>
<p>以后我们就可以在这个新的镜像上建立容器进行各种操作，之前的容器可以不要了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/02/Elasticsearch常用查询过滤语句/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/02/Elasticsearch常用查询过滤语句/" itemprop="url">Elasticsearch常用查询过滤语句</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-02T00:45:59+08:00">
                2019-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Elasticsearch的语法上手有些难度，会出现很多嵌套，一开始还真被它吓着了</p>
</blockquote>
<h1 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h1><p>在查询上下文中，查询会回答这个问题——“这个文档匹不匹配这个查询，它的相关度高么？”<br>如何验证匹配很好理解，如何计算相关度呢？ES中索引的数据都会存储一个“_score”分值，分值越高就代表越匹配。另外关于某个搜索的分值计算还是很复杂的，因此也需要一定的时间。<br>查询上下文 是在 使用query进行查询时的执行环境，比如使用search的时候。<br>一些query的场景：</p>
<ul>
<li>与full text search的匹配度最高</li>
<li>包含run单词，如果包含这些单词：runs、running、jog、sprint，也被视为包含run单词</li>
<li>包含quick、brown、fox。这些词越接近，这份文档的相关性就越高</li>
</ul>
<h2 id="match-all查询"><a href="#match-all查询" class="headerlink" title="match_all查询"></a>match_all查询</h2><p>可以查询到所有文档，是没有查询条件下的默认语句。此查询常用于合并过滤条件。 比如说你需要检索所有的邮箱,所有的文档相关性都是相同的，所以得到的_score为1<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;:&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="match查询"><a href="#match查询" class="headerlink" title="match查询"></a>match查询</h2><p>match查询是一个标准查询，不管你需要全文本查询还是精确查询基本上都要用到它。如果你使用 match 查询一个全文本字段，它会在真正查询之前用分析器先分析match一下查询字符，以下语句，tweet包含“About”、“Search”，或者同时包含“About”和“Search”的记录都会被返回：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;tweet&quot;: &quot;About Search&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果用match下指定了一个确切值，在遇到数字，日期，布尔值或者not_analyzed 的字符串时，它将为你搜索你给定的值：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;match&quot;: &#123; &quot;age&quot;:    26           &#125;&#125;</span><br><span class="line">&#123; &quot;match&quot;: &#123; &quot;date&quot;:   &quot;2014-09-01&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;match&quot;: &#123; &quot;public&quot;: true         &#125;&#125;</span><br><span class="line">&#123; &quot;match&quot;: &#123; &quot;tag&quot;:    &quot;full_text&quot;  &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>提示： 做精确匹配搜索时，你最好用过滤语句，因为过滤语句可以缓存数据。match查询只能就指定某个确切字段某个确切的值进行搜索，而你要做的就是为它指定正确的字段名以避免语法错误。</p>
<h2 id="multi-match-查询"><a href="#multi-match-查询" class="headerlink" title="multi_match 查询"></a>multi_match 查询</h2><p>multi_match查询允许你做match查询的基础上同时搜索多个字段，在多个字段中同时查一个，例如我想查询title字段和body字段都含有“text”的记录：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">            &quot;query&quot;:    &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;:   [ &quot;title&quot;, &quot;body&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="bool查询"><a href="#bool查询" class="headerlink" title="bool查询"></a>bool查询</h2><p>bool 查询与 bool 过滤相似，用于合并多个查询子句。不同的是，bool 过滤可以直接给出是否匹配成功， 而bool 查询要计算每一个查询子句的_score （相关性分值）。</p>
<ul>
<li>must：查询指定文档一定要被包含。</li>
<li>must_not：查询指定文档一定不要被包含。</li>
<li>should：查询指定文档，有则可以为文档相关性加分。</li>
</ul>
<p>以下查询将会找到 title 字段中包含 “how to make millions”，并且 “tag” 字段没有被标为 spam。 如果有标识为 “starred” 或者发布日期为2014年之后，那么这些匹配的文档将比同类网站等级高：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;bool&quot;:&#123;</span><br><span class="line">            &quot;must&quot;:&#123; </span><br><span class="line">                &quot;match&quot;: &#123; </span><br><span class="line">                    &quot;title&quot;: &quot;how to make millions&quot; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;must_not&quot;:&#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                    &quot;tag&quot;:   &quot;spam&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;should&quot;:[</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match&quot;:&#123;</span><br><span class="line">                        &quot;tag&quot;: &quot;starred&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;range&quot;:&#123;</span><br><span class="line">                        &quot;date&quot;: &#123; &quot;gte&quot;: &quot;2014-01-01&quot; &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提示： 如果bool 查询下没有must子句，那至少应该有一个should子句。但是 如果有must子句，那么没有should子句也可以进行查询。</p>
<h2 id="wildcards-查询"><a href="#wildcards-查询" class="headerlink" title="wildcards 查询"></a>wildcards 查询</h2><p>使用标准的shell通配符查询<br>以下查询能够匹配包含W1F 7HW和W2F 8HW的文档：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;wildcard&quot;: &#123;</span><br><span class="line">            &quot;postcode&quot;: &quot;W?F*HW&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>又比如下面查询 hostname 匹配下面shell通配符的：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;wildcard&quot;: &#123;</span><br><span class="line">            &quot;hostname&quot;: &quot;wxopen*&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="正则查询"><a href="#正则查询" class="headerlink" title="正则查询"></a>正则查询</h2><p>假设只想匹配以W开头，紧跟着数字的邮政编码。使用regexp查询能够让你写下更复杂的模式：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&apos;:&#123;</span><br><span class="line">        &quot;regexp&quot;:&#123;</span><br><span class="line">	    &quot;postcode&quot;: &quot;W[0-9].+&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面例子是所有以 wxopen 开头的正则<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&apos;:&#123;</span><br><span class="line">        &quot;regexp&quot;:&#123;</span><br><span class="line">	    &quot;postcode&quot;: &quot;wxopen.*&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="prefix查询"><a href="#prefix查询" class="headerlink" title="prefix查询"></a>prefix查询</h2><p>以什么字符开头的，可以更简单地用 prefix，如下面的例子：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&apos;:&#123;</span><br><span class="line">        &quot;prefix&quot;:&#123;</span><br><span class="line">	    &quot;postcode&quot;: &quot;wxopen&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="短语查询"><a href="#短语查询" class="headerlink" title="短语查询"></a>短语查询</h2><p>当你需要寻找邻近的几个单词时，你会使用match_phrase查询：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&apos;:&#123;</span><br><span class="line">        &quot;match_phrase&quot;:&#123;</span><br><span class="line">	    &quot;title&quot;: &quot;quick brown fox&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>和match查询类似，match_phrase查询首先解析查询字符串来产生一个词条列表。然后会搜索所有的词条，但只保留含有了所有搜索词条的文档，并且词条的位置要邻接。一个针对短语quick fox的查询不会匹配我们的任何文档，因为没有文档含有邻接在一起的quick和box词条。<br>match_phrase查询也可以写成类型为phrase的match查询：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&apos;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">	    &quot;title&quot;: &#123;</span><br><span class="line">                &quot;query&quot;:&quot;quick brown fox&quot;,</span><br><span class="line">		&quot;type&quot;:&quot;phrase&quot;</span><br><span class="line">	    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Filter-DSL"><a href="#Filter-DSL" class="headerlink" title="Filter DSL"></a>Filter DSL</h1><p>在过滤器上下文中，查询会回答这个问题——“这个文档匹不匹配？”<br>答案很简单，是或者不是。它不会去计算任何分值，也不会关心返回的排序问题，因此效率会高一点。<br>过滤上下文 是在使用filter参数时候的执行环境，比如在bool查询中使用Must_not或者filter。<br>另外，经常使用过滤器，ES会自动的缓存过滤器的内容，这对于查询来说，会提高很多性能。<br>一些过滤的情景：</p>
<ul>
<li>创建日期是否在2013-2014年间？</li>
<li>status字段是否为published？</li>
<li>lat字段是否在某个坐标的10公里范围内？</li>
</ul>
<h2 id="term-过滤"><a href="#term-过滤" class="headerlink" title="term 过滤"></a>term 过滤</h2><p>尽管看上去像个“查询”，但是如果结果不完全符合条件它是不会返回的。<br>term主要用于精确匹配哪些值，比如数字，日期，布尔值或 string 的字符串(未经分析的文本数据类型)，我的理解是，它不会对term的条件再进行分词：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">	&quot;term&quot;:&#123;</span><br><span class="line">	    &quot;prj_name&quot;:&quot;汕尾土建&quot;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上语句，prj name为“汕尾XXXXX土建”的记录并不会被返回。</p>
<h2 id="terms-过滤"><a href="#terms-过滤" class="headerlink" title="terms 过滤"></a>terms 过滤</h2><p>terms 跟 term 有点类似，但 terms 允许指定多个匹配条件。 如果某个字段指定了多个值，那么文档需要一起去做匹配（就是说，只要满足其中之一的条件）：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">	&quot;terms&quot;:&#123;</span><br><span class="line">	    &quot;prj_name&quot;:[&quot;汕尾&quot;,&quot;土建&quot;]</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上语句，可以返回prj name为“汕尾XXXXX”和“江门XX土建”的记录。</p>
<h2 id="range过滤"><a href="#range过滤" class="headerlink" title="range过滤"></a>range过滤</h2><p>range过滤允许我们按照指定范围查找一批数据，例如寻找“年龄为20岁到30岁之间的记录”：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">	&quot;range&quot;:&#123;</span><br><span class="line">	    &quot;age&quot;:&#123;</span><br><span class="line">		&quot;gte&quot;:20,</span><br><span class="line">		&quot;lte&quot;:30</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="exists-和-missing-过滤"><a href="#exists-和-missing-过滤" class="headerlink" title="exists 和 missing 过滤"></a>exists 和 missing 过滤</h2><p>exists 和 missing 过滤可以用于查找文档中是否包含指定字段或没有某个字段，类似于SQL语句中的IS NOT NUL和IS NULL条件。<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">	&quot;exists&quot;:   &#123;</span><br><span class="line">	    &quot;field&quot;:true</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="bool过滤"><a href="#bool过滤" class="headerlink" title="bool过滤"></a>bool过滤</h2><p>bool下可以跟“filter”。官网的解释是这样的：“The clause (query) must appear in matching documents. However unlike must the score of the query will be ignored. Filter clauses are excuted in filter context, meaning that scoring is ignored and clauses are considered for caching”。按照我的理解，基本等同于bool查询的must吧，只不过省略了评分（全部为0），快一些，可以用到缓存。<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;bool&quot;:&#123;</span><br><span class="line">            &quot;filter&quot;:&#123; </span><br><span class="line">                &quot;match&quot;: &#123; </span><br><span class="line">                    &quot;title&quot;: &quot;how to make millions&quot; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/01/解决Docker容器与主机时间不同步问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sea Monster">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="量">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/01/解决Docker容器与主机时间不同步问题/" itemprop="url">解决Docker容器与主机时间不同步问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-01T17:05:03+08:00">
                2019-09-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在Docker容器运行后，可能会发现容器时间与宿主机时间不一致，一般会差8个小时。这样会造成在容器中运行的web程序打出的日志时间与实际时间不一致，如果web程序中有定时任务也会造成影响等，需要对宿主机和容器进行时间同步。</p>
</blockquote>
<p>宿主机时间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZwz9aiqq9qrjr7ovag8caZ ~] date</span><br><span class="line">2019年 8月28日 星期三 11时31分03秒 CST</span><br></pre></td></tr></table></figure></p>
<p>容器时间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ac1c371435ac:/# date</span><br><span class="line">Wed Aug 28 03:31:03 UTC 2019</span><br></pre></td></tr></table></figure></p>
<p>可以看到宿主机和容器时间相查8个小时，宿主机采用CST时区，CST是指China Shanghai Time，东八区时间；容器采用UTC时区，UTC应该是指Coordinated Universal Time，标准时间。</p>
<p><strong>统一两者的办法是共享主机的时间与时区</strong><br>网上有说共享主机localtime的，有说设置时区的，我发现，只做其中一种方法的话，有些能成功，有些不成功，例如进入容器内看到时间是东八区的时间了，但是打印出来的日志还是UTC。如果localtime与timezone一起设置的话貌似能保证成功：   </p>
<ol>
<li><p>我们先看看宿主机的时区，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/timezone</span><br><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure>
</li>
<li><p>有时候宿主机没有，我们要创建一个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/timezone</span><br><span class="line">cat: /etc/timezone: No such file or directory</span><br><span class="line"># 如果要创建/etc/timezone，需要root账号，用一般账号sudo也不行</span><br><span class="line">$ echo &quot;Asia/Shanghai&quot; &gt; /home/tisson/timezone</span><br></pre></td></tr></table></figure>
</li>
<li><p>共享主机的localtime与timezone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 如果宿主机有/etc/timezone</span><br><span class="line">$ docker run -d --name zk -p 2181:2181 -p 2888:2888 -p 3888:3888 -v /etc/localtime:/etc/localtime:ro -v /etc/timezone:/etc/timezone:ro wurstmeister/zookeeper:3.4.6</span><br><span class="line"></span><br><span class="line"># 如果宿主机没有/etc/timezone，我们就用自己创建的timezone</span><br><span class="line">$ docker run -d --name zk -p 2181:2181 -p 2888:2888 -p 3888:3888 -v /etc/localtime:/etc/localtime:ro -v /home/tisson/timezone:/etc/timezone:ro wurstmeister/zookeeper:3.4.6</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>注意：某些容器日志信息用的是自带JVM的时区，如果要改变时区，可能需要具体分析通过设置什么参数改变这个时区。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Sea Monster</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sea Monster</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
